<mujoco model="Flappy_v8_JointInput">
<!-- NOTE:
    - Propellers were added as control input.
    - Checked Mass property (45 and 95g total),
    - more accurate thrust/torque limit (0.35N) from the rotor
    - Orientation setting to align IMU with world frame.
    - Please use IMU sensor of orientation and position
    - V8 has the same initial joint angles as the MATLAB code.
    - This version uses simple open-loop kinematic chain
    - The first two actuator "J5_angle", "J6_angle" is used to set the wing joint angle
    - Camera is included
    -->
  <compiler angle="radian" 
            meshdir="../assets/meshes_v8" 
            texturedir="../assets/environments"
            balanceinertia="true" />
  <!-- <compiler angle="radian" meshdir="../assets/meshes_v8" balanceinertia="true" /> -->

  <!-- <statistic meansize="0.0652069" extent="0.541984" center="0.0122683 -0.0367867 0.0356997"/> -->
<!--  <option impratio="1" timestep="2e-5" gravity="0 0 -9.81" integrator="implicitfast"  density="1.225" viscosity="1.789e-5">-->
  <!-- <include file="cage.xml"/> -->
  <option impratio="1" gravity="0 0 -9.81"  integrator="implicit" density="0" viscosity="1.789e-5">
<!--  <option impratio="1"  gravity="0 0 -9.81"  integrator="implicit" > Uncomment this to disable aerodynamics-->
<!--    <flag contact="disable"/>-->
  </option>

  <asset>
    <!-- <mesh name="Base" file="Base.STL"/> -->
    <mesh name="Core" file="Base_no_prop.STL"/>
    <mesh name="Guard" file="guard.stl"/>
    <mesh name="L1" file="L1.STL"/>
    <mesh name="L2" file="L2.STL"/>
    <mesh name="L1R" file="L1R.STL"/>
    <mesh name="L2R" file="L2R.STL"/>
    <mesh name="L3" file="L3.STL"/>
    <mesh name="L7" file="L7.STL"/>
    <mesh name="L6" file="L6.STL"/>
    <mesh name="L5" file="L5.STL"/>
    <mesh name="L4" file="L4.STL"/>
    <mesh name="L3R" file="L3R.STL"/>
    <mesh name="L7R" file="L7R.STL"/>
    <mesh name="L6R" file="L6R.STL"/>
    <mesh name="L5R" file="L5R.STL"/>
    <mesh name="L4R" file="L4R.STL"/>
    <mesh name="Proximal_L" file="Proximal_L.STL"/>
    <mesh name="Proximal_R" file="Proximal_R.STL"/>
    <mesh name="Distal_L" file="Distal_L.STL"/>
    <mesh name="Distal_R" file="Distal_R.STL"/>
    <mesh name="cave_mesh" file="cave_world.obj" />
  </asset>

  <default>
    <geom contype="0" conaffinity="0" condim="1" solref="0.001 1"/>
    <equality solref="1e-10 1"/>
    <default class="visual">
      <geom group="2" type="mesh" contype="0" conaffinity="0" rgba="1 1 1 1" density="0" />
    </default>
    <default class="collision">
<!--      <geom contype="1" group="3" type="mesh" density="0" />-->
      <geom contype="1" group="3" density="0" />
    </default>
    <default class="aerodynamics">
      <geom group="2" type="mesh" contype="0" conaffinity="0" rgba="1 1 1 1" density="0" fluidshape="ellipsoid"/>
    </default>
  </default>

    <!-- <include file="cage.xml"/> -->

  <worldbody>

    <!-- <body name="Aerobat" pos='0 0 0.5' quat="1 0 0 0"> -->
    <body name="Core" pos= "0 0 1.0" quat="1 0 0 0">  <!-- Spawning at 1m height to be inside cage -->
        <camera name="onboard_camera" pos="0 0 0.1" quat="0.707 0.707 -0.707 -0.707" fovy="60" resolution="640 480"/>
        <freejoint/>
                
        <geom class="collision" mesh="Core"/>
        <geom class="visual" mesh="Core"/>
        <inertial pos="0 0 0" quat="1 0 0 0" mass="0.030" diaginertia="1.905e-03 6.872e-04 2.261e-03"/> <!-- Core -0.015 -->

        <!-- Visual axes for Core body (to see if it rotates differently from Guard) -->
        <site name="core_x_axis" type="box" pos=".08 .0 .0" size=".08 .003 .003" quat="1 0 0 0" rgba="1 0 0 0.7"/>
        <site name="core_y_axis" type="box" pos=".0 .08 .0" size=".08 .003 .003" quat=".707 0 0 .707" rgba="0 1 0 0.7"/>
        <site name="core_z_axis" type="box" pos=".0 .0 .08" size=".08 .003 .003" quat="-.707 0 .707 0" rgba="0 0 1 0.7"/>

        <!-- IMU site for Core body -->
        <site name="core_imu" pos="-0.015 0 0" quat="1 0 0 0"/>

        <!-- Guard as child body with ball joint connection -->
        <body name="Guard" pos="0 0 0" quat="1 0 0 0">
            <!-- 6-DOF compliant connection: 3 translations + 3 rotations (rubber band behavior) -->
            <!-- Translation spring-dampers (very soft for visible rubber band stretch) -->
            <joint name="guard_slide_x" type="slide" axis="1 0 0" stiffness="8" damping="1" limited="true" range="-0.2 0.2"/>
            <joint name="guard_slide_y" type="slide" axis="0 1 0" stiffness="8" damping="1" limited="true" range="-0.2 0.2"/>
            <joint name="guard_slide_z" type="slide" axis="0 0 1" stiffness="8" damping="1" limited="true" range="-0.2 0.2" springref="-0.015"/>
            <!-- Rotation spring-dampers (soft for visible rotation) -->
            <joint name="guard_ball" type="ball" stiffness="10" damping="1" limited="true" range="0 0.3"/>

                <!-- Visual axes for Guard body (to see relative rotation) -->
                <site name="guard_x_axis" type="box" pos=".06 .0 .0" size=".06 .004 .004" quat="1 0 0 0" rgba="1 0.5 0 0.9"/>
                <site name="guard_y_axis" type="box" pos=".0 .06 .0" size=".06 .004 .004" quat=".707 0 0 .707" rgba="0.5 1 0 0.9"/>
                <site name="guard_z_axis" type="box" pos=".0 .0 .06" size=".06 .004 .004" quat="-.707 0 .707 0" rgba="0 0.5 1 0.9"/>

                <!-- IMU site for Guard body -->
                <site name="guard_imu" pos="0 0 0" quat="1 0 0 0"/>

                <site name="motor1" type="cylinder" pos="0.148 .0 .0" size=".01 0.0025" quat="1 0 0 0" rgba=".3 .8 .3 1"/> <!--Front-->
                <site name="motor2" type="cylinder" pos="-0.175 .0 .0" size=".01 0.0025" quat="1 0 0 0" rgba=".3 .8 .3 1"/> <!--Back-->
                <site name="motor3" type="cylinder" pos="-0.0135 -0.236 .0" size=".01 .0025" quat="1 0 0 0" rgba=".3 .8 .3 1"/> <!--Right-->
                <site name="motor4" type="cylinder" pos="-0.0135 0.236 .0" size=".01 .0025" quat="1 0 0 0" rgba=".3 .8 .3 1"/> <!--Left-->

                <site name="motor5" type="cylinder" pos="-0.02309409 -0.28340624 0.00202624" size=".01 .0025" quat="0.7071068 0 0.7071068 0" rgba=".3 .8 .3 1"/> <!--Left-->
                <site name="motor6" type="cylinder" pos="-0.00397818 0.28319645 0.00210978" size=".01 .0025" quat="0.7071068 0 0.7071068 0" rgba=".3 .8 .3 1"/> <!--Right-->

                <geom class="collision" mesh="Guard"/>
                <geom class="visual" mesh="Guard"/>
                <inertial pos="0 0 0" quat="1 0 0 0" mass="0.07" diaginertia="1.905e-03 6.872e-04 2.261e-03"/> <!--With guard (prop)-->
            </body>

            <body name="L3" pos="0.0052 0.020673 0.0075244" quat="0.372893 0.60079 0.372898 0.60079">

                <inertial pos="0.0243413 -0.00482289 -0.0243401" quat="0.795566 -0.0119647 -0.00383338 0.605736" mass="0.00170505" diaginertia="4.01765e-06 3.70297e-06 3.24993e-07"/>
                <joint name="J5" type='hinge' pos="0 0 0" axis="0 0 1" damping="0.01"/>
                <geom class="collision" mesh="L3"/>
                <geom class="visual" mesh="L3"/>
                <geom class="aerodynamics" mesh="Proximal_L"/>
                <body name="L7" pos="0.074121 -0.030565 -0.001" quat="0.932157 0 0 -0.362054">
                <inertial pos="0.0175244 -0.0044015 0.000591145" quat="0.694089 0.156825 0.157693 0.684675" mass="0.00371107" diaginertia="1.26925e-05 9.98807e-06 2.75403e-06"/>
                <joint name="J6" type='hinge' pos="-0.035 0 0.001" axis="0 0 1" damping="0.02"/>
                <geom class="collision" mesh="L7"/>
                <geom class="visual" mesh="L7"/>
                <geom class="aerodynamics" mesh="Distal_L"/>
                </body>
            </body>

            <body name="L3R" pos="-0.0042 -0.020673 0.0075244" quat="0.600789 0.372896 -0.600792 -0.372896">
                <!-- <site name="bat_site" pos="0 0 0" size="0.005" rgba="0 1 0 1"/> -->
                <inertial pos="0.0243414 -0.0048229 0.0170716" quat="0.79594 0.00867428 0.00295725 0.605306" mass="0.00170505" diaginertia="3.88055e-06 3.56509e-06 3.26048e-07"/>
                <joint name="J5R" pos="0 0 0" axis="0 0 1" damping="0.01"/>
                <geom class="collision" mesh="L3R"/>
                <geom class="visual" mesh="L3R"/>
                <geom class="aerodynamics" mesh="Proximal_R"/>
                <body name="L7R" pos="0.074121 -0.030565 -0.001" quat="0.932157 0 0 -0.362054">
                <inertial pos="0.0175244 -0.0044015 -0.00700329" quat="0.692947 -0.158508 -0.157599 0.685465" mass="0.00371107" diaginertia="1.27171e-05 1.00415e-05 2.72544e-06"/>
                <joint name="J6R" pos="-0.035 0 0.001" axis="0 0 1" damping="0.02"/>
                <geom class="collision" mesh="L7R"/>
                <geom class="visual" mesh="L7R"/>
                <geom class="aerodynamics" mesh="Distal_R"/>
                </body>
            </body>
        <site name="body_frame" pos="-0.015 0 0" quat="1 0 0 0"/>
        <site name="x_axis_b" type="box" pos=".1 .0 .0" size=".15 .005 .005" quat="1 0 0 0" rgba="1 0 0 0.2"/>
        <site name="y_axis_b" type="box" pos=".0 .1 .0" size=".15 .005 .005" quat=".707 0 0 .707" rgba="0 1 0 0.2"/>
        <site name="z_axis_b" type="box" pos=".0 .0 .1" size=".15 .005 .005" quat="-.707 0 .707 0" rgba="0 0 1 0.2"/>
        </body>
        <!-- </body> -->
    <site name="x_axis" type="box" pos=".1 .0 .0" size=".15 .005 .005" quat="1 0 0 0" rgba="1 0 0 0.2"/>
    <site name="y_axis" type="box" pos=".0 .1 .0" size=".15 .005 .005" quat=".707 0 0 .707" rgba="0 1 0 0.2"/>
    <site name="z_axis" type="box" pos=".0 .0 .1" size=".15 .005 .005" quat="-.707 0 .707 0" rgba="0 0 1 0.2"/>
  </worldbody>

  <sensor>
    <!-- Keep body_frame for backward compatibility (references Core IMU) -->
    <framepos name="Body_pos" objtype="site" objname="body_frame"/>       <!-- datasensor[0:3] -->
    <framequat name="Body_quat" objtype="site" objname="body_frame"/>     <!-- datasensor[3:7] -->
    <framelinvel name="Body_linvel" objtype="site" objname="body_frame"/> <!-- datasensor[7:10] -->
    <gyro name="Body_angvel_local" site="body_frame" noise="0.0000001"/>                    <!-- datasensor[10:13] -->
    <accelerometer name="Body_linacc_local" site="body_frame" noise="0.000002"/>           <!-- datasensor[13:16] -->
    
    <!-- Core IMU (attached to Core body) -->
    <gyro name="Core_gyro" site="core_imu" noise="0.0000001"/>                    <!-- datasensor[16:19] -->
    <accelerometer name="Core_accel" site="core_imu" noise="0.000002"/>           <!-- datasensor[19:22] -->
    
    <!-- Guard IMU (attached to Guard body) -->
    <gyro name="Guard_gyro" site="guard_imu" noise="0.0000001"/>                  <!-- datasensor[22:25] -->
    <accelerometer name="Guard_accel" site="guard_imu" noise="0.000002"/>         <!-- datasensor[25:28] -->
    
    <!-- Core Ground Truth (attached to Core body) -->
    <framepos name="Core_GT_pos" objtype="site" objname="core_imu"/>              <!-- datasensor[28:31] -->
    <framequat name="Core_GT_quat" objtype="site" objname="core_imu"/>            <!-- datasensor[31:35] -->
    <framelinvel name="Core_GT_linvel" objtype="site" objname="core_imu"/>        <!-- datasensor[35:38] -->
    <frameangvel name="Core_GT_angvel" objtype="site" objname="core_imu"/>        <!-- datasensor[38:41] -->
    
    <!-- Guard Ground Truth (attached to Guard body) -->
    <framepos name="Guard_GT_pos" objtype="site" objname="guard_imu"/>            <!-- datasensor[41:44] -->
    <framequat name="Guard_GT_quat" objtype="site" objname="guard_imu"/>          <!-- datasensor[44:48] -->
    <framelinvel name="Guard_GT_linvel" objtype="site" objname="guard_imu"/>      <!-- datasensor[48:51] -->
    <frameangvel name="Guard_GT_angvel" objtype="site" objname="guard_imu"/>      <!-- datasensor[51:54] -->
    
<!--    <frameangvel name="Body_angvel" objtype="site" objname="body_frame"/>-->
<!--    <velocimeter name="Body_linvel_local" site="body_frame"/>-->
  </sensor>

  <equality>
    <joint name = 'J5-eq' joint1='J5'  joint2='J5R' polycoef="0 1 0 0 0"/>
    <joint name = 'J6-eq' joint1='J6'  joint2='J6R' polycoef="0 1 0 0 0"/>
  </equality>

  <actuator>
    <position name="J5_angle" joint="J5" ctrllimited="true" ctrlrange="-10 10" kp="20"/>
    <position name="J6_angle" joint="J6" ctrllimited="true" ctrlrange="-10 10" kp="20"/>

    <motor name="Motor1" ctrllimited="true" ctrlrange="0 1" gear="0  0. 0.35 0. 0. -0.0056" site="motor1"/> <!--unit: N-->
    <motor name="Motor2" ctrllimited="true" ctrlrange="0 1" gear="0  0. 0.35 0. 0. -0.0056" site="motor2"/>
    <motor name="Motor3" ctrllimited="true" ctrlrange="0 1" gear="0  0. 0.35 0. 0. -0.0056" site="motor3"/>
    <motor name="Motor4" ctrllimited="true" ctrlrange="0 1" gear="0  0. 0.35 0. 0. -0.0056" site="motor4"/>
    <motor name="Motor5" ctrllimited="true" ctrlrange="0 1" gear="0  0. .1 0. 0.  0.0016" site="motor5"/>
    <motor name="Motor6" ctrllimited="true" ctrlrange="0 1" gear="0  0. -.1 0. 0. -0.0016" site="motor6"/>
  </actuator>

</mujoco>
